<!DOCTYPE html>
<html>
<head>
  <title>EduPickup App – Parent</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="edupickuplogo.png">
  <link rel="apple-touch-icon" href="edupickuplogo.png">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2GE589Z2W2"></script>
  <meta name="google-adsense-account" content="ca-pub-1200109181407050">
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2GE589Z2W2');
  </script>
</head>
<body>
  <h2>Ridicare copil - Ecran părinte</h2>
  <div style="text-align:center; margin-bottom:25px;margin-top: 10px;">
    <img src="edupickuplogo.png" alt="EduPickup Logo" style="max-width:100px; height:auto;">
  </div>

  <div id="main"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script>
    const API_BASE = 'https://unwailed-creepier-cory.ngrok-free.dev'; // replace with your actual tunnel
    const groupName = new URLSearchParams(window.location.search).get('group')?.trim().toLowerCase() || 'scoala4-clasa1e';

    const fetchWithHeaders = (url, options = {}) => {
      options.headers = {
        ...options.headers,
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
      };
      return fetch(url, options);
    };

    fetchWithHeaders(`${API_BASE}/analytics`, {
      method: 'POST',
      body: JSON.stringify({
        page: 'parent',
        group: groupName,
        event: 'view',
        timestamp: new Date().toISOString()
      })
    });

    gtag('event', 'page_view', {
      page_title: 'Parent Check-In',
      page_location: window.location.href,
      page_path: '/parent.html',
      group: groupName
    });

    const demoChildren = [
      {id: 1, name: 'Sacelean Sara'},
      {id: 2, name: 'Ana Popescu'},
      {id: 3, name: 'Lucas Georgescu'},
      {id: 4, name: 'Tudor Dobre'},
      {id: 5, name: 'Vlad Stan'},
      {id: 6, name: 'Sara Pavel'},
      {id: 7, name: 'Radu Enache'},
      {id: 8, name: 'Eddie Munteanu'},
      {id: 9, name: 'Darius Ilie'},
      {id: 10, name: 'Ionescu Maria'}
    ];

    const $ = (s) => document.querySelector(s);
    const humanTime = (iso) => new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const normalizeName = (name) => name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, '').trim();

    function showParent() {
      $('#main').innerHTML = `
        <div>
          <label>Nume copil</label><br/>
          <input type="text" id="childInput" placeholder="ex: Ionescu Maria"><br/><br/>
          <label>Cine ridică?</label><br/>
          <select id="whoSelect"><option>Tata</option><option>Mama</option><option>Bunica</option><option>Altă persoană</option></select><br/><br/>
          <label>Notă (opțional)</label><br/>
          <input type="text" id="noteInput"><br/><br/>
          <button id="checkInBtn">Sunt la poartă</button>
          <div id="confirm" style="margin-top:10px; display:none;"></div>
        </div>
      `;

      $('#checkInBtn').addEventListener('click', async () => {
        const fullName = $('#childInput').value.trim();
        const who = $('#whoSelect').value;
        const note = $('#noteInput').value.trim();
        const inputName = normalizeName(fullName);
        const child = demoChildren.find(c => normalizeName(c.name) === inputName);

        if (!child) {
          $('#confirm').style.display = 'block';
          $('#confirm').innerHTML = `<div style="color:red">❌ Numele copilului nu este cunoscut. Vă rugăm introduceți numele sub forma: nume familie + prenume</div>`;
          return;
        }

        const evt = {
          child_id: child.id,
          child_name: child.name,
          who,
          note,
          status: 'arrived',
          group_name: groupName
        };

        const res = await fetchWithHeaders(`${API_BASE}/events`, {
          method: 'POST',
          body: JSON.stringify(evt)
        });

        const saved = await res.json();
        $('#confirm').style.display = 'block';
        $('#confirm').innerHTML = `✅ Ai raportat sosirea pentru <strong>${saved.child_name}</strong> la ${humanTime(saved.ts)}.`;
        $('#noteInput').value = '';
        $('#childInput').value = '';
      });
    }

    window.onload = () => {
      showParent();

      const qrUrl = `https://unwailed-creepier-cory.ngrok-free.dev/parent.html?group=${groupName}`;
      QRCode.toCanvas(document.getElementById('qrCanvas'), qrUrl, { width: 180 }, function (error) {
        if (error) console.error(error);
      });
    };
  </script>

  <footer style="text-align:center; padding:20px; font-size:14px; color:#faf4f4;">
    &copy; 2025 EduPickup. Toate drepturile rezervate.
  </footer>
</body>
</html>
